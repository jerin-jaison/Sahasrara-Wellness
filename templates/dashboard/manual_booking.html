{% extends "dashboard/base.html" %}
{% block title %}Manual Booking{% endblock %}
{% block page_title %}Create Manual Booking{% endblock %}

{% block content %}

<div class="breadcrumb">
    <a href="{% url 'dashboard:booking_list' %}">Bookings</a>
    <span class="breadcrumb-sep">/</span>
    <span class="breadcrumb-current">Manual Booking</span>
</div>

<div class="row g-0 mb-3">
    <div class="col-12">
        <div class="booking-notice"
            style="background:linear-gradient(90deg,var(--gold-dim),transparent);border-left:3px solid var(--gold);border-radius:0 10px 10px 0;padding:14px 20px;font-size:13.5px;color:var(--text-mid);">
            üí° Create a booking on behalf of a guest ‚Äî payment is automatically <strong>waived</strong> and status set
            to <strong>Confirmed</strong>. A confirmation email is sent instantly.
        </div>
    </div>
</div>

<form method="POST" id="manualBookingForm">
    {% csrf_token %}

    <!-- Section 1: Guest -->
    <div class="form-section">
        <div class="form-section-title">üë§ Guest Information</div>
        <div class="row g-3">
            <div class="col-12 col-md-4">
                <div class="form-group mb-0">
                    <label class="form-label">Full Name *</label>
                    <input type="text" name="guest_name" class="form-control" required placeholder="Full name"
                        value="{{ request.POST.guest_name }}">
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="form-group mb-0">
                    <label class="form-label">Phone *</label>
                    <input type="tel" name="guest_phone" class="form-control" required placeholder="+91 99999 99999"
                        value="{{ request.POST.guest_phone }}">
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="form-group mb-0">
                    <label class="form-label">Email</label>
                    <input type="email" name="guest_email" class="form-control" placeholder="guest@example.com"
                        value="{{ request.POST.guest_email }}">
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: Booking -->
    <div class="form-section">
        <div class="form-section-title">üìÖ Booking Details</div>
        <div class="row g-3">
            <div class="col-12 col-md-4">
                <div class="form-group mb-0">
                    <label class="form-label">Branch *</label>
                    <select name="branch_id" id="branch_sel" class="form-control" required onchange="filterByBranch()">
                        <option value="">Select branch‚Ä¶</option>
                        {% for b in branches %}<option value="{{ b.id }}" {% if b.id|stringformat:"s" == post_branch_id%}selected{% endif %} data-city="{{ b.city }}">{{b.name }}</option>{% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="form-group mb-0">
                    <label class="form-label">Service *</label>
                    <select name="service_id" id="service_sel" class="form-control" required>
                        <option value="">Select service‚Ä¶</option>
                        {% for s in services %}<option value="{{ s.id }}" {% if s.id|stringformat:"s" == post_service_id%}selected{% endif  %}data-branches="{% for b in s.branches.all %}{{ b.id }} {% endfor %}">{{ s.name }}
                            ({{s.duration_minutes }} min) ‚Äî ‚Çπ{{ s.price|floatformat:0 }}</option>{% endfor%}
                    </select>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="form-group mb-0">
                    <label class="form-label">Therapist *</label>
                    <select name="worker_id" id="worker_sel" class="form-control" required>
                        <option value="">Select therapist‚Ä¶</option>
                        {% for w in workers %}<option value="{{ w.id }}" {% if w.id|stringformat:"s" == post_worker_id%}selected{% endif %} data-branch="{{ w.branch_id }}">
                            {{ w.name }}</option>{% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Schedule -->
    <div class="form-section">
        <div class="form-section-title">üïê Schedule</div>
        <div class="row g-3">
            <div class="col-12 col-sm-6 col-md-3">
                <div class="form-group mb-0">
                    <label class="form-label">Date *</label>
                    <input type="date" name="booking_date" class="form-control" required min="{{ today }}"
                        value="{{ request.POST.booking_date }}">
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="form-group mb-0">
                    <label class="form-label">Available Time Slots *</label>
                    <div id="slots-grid" class="slots-grid mt-2">
                        <p class="small text-muted mb-0" id="slots-placeholder">Select Date, Service, and Therapist to
                            see availability.</p>
                    </div>
                    <div id="slots-error" class="small text-danger mt-2" style="display:none;"></div>
                    <input type="hidden" name="start_time" id="start_time_hidden" required>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 4: Notes -->
    <div class="form-section">
        <div class="form-section-title">üìù Admin Notes</div>
        <div class="form-group mb-0">
            <textarea name="notes" class="form-control" rows="3"
                placeholder="Internal notes (not visible to guest)‚Ä¶">{{ request.POST.notes }}</textarea>
        </div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button type="submit" class="btn btn-gold">‚úÖ Create Manual Booking</button>
        <a href="{% url 'dashboard:booking_list' %}" class="btn btn-ghost">Cancel</a>
    </div>
</form>

<script>
    function filterByBranch() {
        var branchId = document.getElementById('branch_sel').value;
        var serviceSel = document.getElementById('service_sel');
        serviceSel.querySelectorAll('option[data-branches]').forEach(function (o) {
            var ids = o.dataset.branches.trim().split(/\s+/);
            o.style.display = (!branchId || ids.includes(branchId)) ? '' : 'none';
        });
        if (serviceSel.value) {
            var cur = serviceSel.querySelector('option[value="' + serviceSel.value + '"]');
            if (cur && cur.style.display === 'none') serviceSel.value = '';
        }
        var workerSel = document.getElementById('worker_sel');
        workerSel.querySelectorAll('option[data-branch]').forEach(function (o) {
            o.style.display = (!branchId || o.dataset.branch === branchId) ? '' : 'none';
        });
        if (workerSel.value) {
            var curW = workerSel.querySelector('option[value="' + workerSel.value + '"]');
            if (curW && curW.style.display === 'none') workerSel.value = '';
        }
        fetchSlots();
    }

    let fetchController = null;
    let debounceTimer = null;

    function fetchSlots() {
        const branchId = document.getElementById('branch_sel').value;
        const serviceId = document.getElementById('service_sel').value;
        const workerId = document.getElementById('worker_sel').value;
        const dateInput = document.querySelector('input[name="booking_date"]');
        const date = dateInput.value;
        const grid = document.getElementById('slots-grid');
        const placeholder = document.getElementById('slots-placeholder');
        const errorMsg = document.getElementById('slots-error');
        const hiddenInput = document.getElementById('start_time_hidden');
        const submitBtn = document.querySelector('button[type="submit"]');

        // Reset UI
        grid.innerHTML = '';
        errorMsg.style.display = 'none';
        hiddenInput.value = '';
        submitBtn.disabled = true;

        if (!branchId || !serviceId || !workerId || !date) {
            if (placeholder) placeholder.style.display = 'block';
            grid.innerHTML = '<p class="small text-muted mb-0">Select Date, Service, and Therapist to see availability.</p>';
            return;
        }

        // Debounce & Cancel previous
        clearTimeout(debounceTimer);
        if (fetchController) fetchController.abort();

        // Show Shimmer
        for (let i = 0; i < 6; i++) {
            const shim = document.createElement('div');
            shim.className = 'shimmer-slot';
            grid.appendChild(shim);
        }

        debounceTimer = setTimeout(() => {
            fetchController = new AbortController();
            const url = `/bookings/api/slots/?branch_id=${branchId}&service_id=${serviceId}&worker_id=${workerId}&date=${date}`;

            fetch(url, { signal: fetchController.signal })
                .then(res => res.json())
                .then(data => {
                    grid.innerHTML = '';
                    if (data.slots && data.slots.length > 0) {
                        data.slots.forEach(slot => {
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'btn slot-btn';
                            btn.innerText = slot.display;
                            btn.onclick = function () {
                                grid.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                                hiddenInput.value = slot.start;
                                submitBtn.disabled = false;
                            };
                            grid.appendChild(btn);
                        });
                    } else {
                        grid.innerHTML = '<p class="small text-gold mb-0">No slots available for this combination. Please try another date or therapist.</p>';
                    }
                })
                .catch(err => {
                    if (err.name === 'AbortError') return;
                    grid.innerHTML = '';
                    errorMsg.innerText = "Error fetching availability. Please try again.";
                    errorMsg.style.display = 'block';
                    console.error("Slot fetch error:", err);
                });
        }, 300);
    }

    document.getElementById('branch_sel').addEventListener('change', filterByBranch);
    document.getElementById('service_sel').addEventListener('change', fetchSlots);
    document.getElementById('worker_sel').addEventListener('change', fetchSlots);
    document.querySelector('input[name="booking_date"]').addEventListener('change', fetchSlots);

    // Initial check
    if (document.getElementById('branch_sel').value) filterByBranch();

    document.getElementById('manualBookingForm').onsubmit = function () {
        if (!document.getElementById('start_time_hidden').value) {
            alert("Please select a time slot.");
            return false;
        }
        const btn = this.querySelector('button[type="submit"]');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Creating‚Ä¶';
        btn.disabled = true;
    };
</script>

{% endblock %}